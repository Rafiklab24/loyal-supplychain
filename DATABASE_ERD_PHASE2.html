<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyal Supply Chain - ERD Phase 2 (Normalized Shipments)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: auto;
        }
        
        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        h1 {
            color: #00ff88;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .subtitle { color: #888; }
        
        .phase-badge {
            display: inline-block;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #888;
        }
        
        .diagram-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        svg {
            display: block;
            margin: 0 auto;
        }
        
        .new-table {
            filter: drop-shadow(0 0 10px rgba(0, 255, 136, 0.4));
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üóÑÔ∏è Loyal Supply Chain - Database ERD</h1>
        <p class="subtitle">Phase 2: Normalized Shipments Structure</p>
        <div class="phase-badge">‚ú® PHASE 2 COMPLETE</div>
        
        <div class="stats">
            <div class="stat"><div class="stat-value">45</div><div class="stat-label">Tables (+5)</div></div>
            <div class="stat"><div class="stat-value">7</div><div class="stat-label">Schemas</div></div>
            <div class="stat"><div class="stat-value">67</div><div class="stat-label">Foreign Keys (+5)</div></div>
            <div class="stat"><div class="stat-value">34</div><div class="stat-label">Audit Triggers (+5)</div></div>
            <div class="stat"><div class="stat-value">2</div><div class="stat-label">New Views</div></div>
        </div>
    </div>
    
    <div class="diagram-container">
        <svg width="1700" height="1100" viewBox="0 0 1700 1100">
            <defs>
                <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto">
                    <path d="M 0 0 L 10 5 L 0 10 z" fill="#666"/>
                </marker>
            </defs>
            
            <!-- TITLE -->
            <text x="850" y="30" text-anchor="middle" fill="#00ff88" font-size="18" font-weight="bold">
                NORMALIZED SHIPMENTS STRUCTURE (Phase 2)
            </text>
            
            <!-- ============ SHIPMENTS MASTER (CENTER) ============ -->
            <g class="table-box" transform="translate(650, 80)">
                <rect width="240" height="220" rx="8" fill="#1a3d1a" stroke="#00ff88" stroke-width="3"/>
                <rect width="240" height="35" rx="8" fill="#00ff88"/>
                <rect y="27" width="240" height="8" fill="#00ff88"/>
                <text x="120" y="25" text-anchor="middle" font-weight="bold" fill="#000" font-size="14">shipments ‚≠ê (MASTER)</text>
                <text x="10" y="55" fill="#ffd700" font-size="11">üîë id (UUID)</text>
                <text x="10" y="73" fill="#fff" font-size="11">sn (shipment number)</text>
                <text x="10" y="91" fill="#fff" font-size="11">direction (IN/OUT)</text>
                <text x="10" y="109" fill="#fff" font-size="11">status</text>
                <text x="10" y="127" fill="#00bfff" font-size="11">‚Üí contract_id</text>
                <text x="10" y="145" fill="#00bfff" font-size="11">‚Üí proforma_id</text>
                <text x="10" y="163" fill="#fff" font-size="11">subject, notes</text>
                <text x="10" y="181" fill="#fff" font-size="11">created_at, updated_at</text>
                <text x="10" y="199" fill="#888" font-size="11">is_deleted, notification_*</text>
                <text x="120" y="215" text-anchor="middle" fill="#00ff88" font-size="10">25 core columns</text>
            </g>
            
            <!-- ============ SHIPMENT_PARTIES (TOP LEFT) ============ -->
            <g class="table-box new-table" transform="translate(50, 80)">
                <rect width="220" height="200" rx="8" fill="#1a3d1a" stroke="#00ff88" stroke-width="2"/>
                <rect width="220" height="35" rx="8" fill="#4ecdc4"/>
                <rect y="27" width="220" height="8" fill="#4ecdc4"/>
                <text x="110" y="25" text-anchor="middle" font-weight="bold" fill="#000" font-size="13">shipment_parties ‚ú®</text>
                <text x="10" y="55" fill="#ffd700" font-size="11">üîë id (UUID)</text>
                <text x="10" y="73" fill="#00bfff" font-size="11">‚Üí shipment_id (FK)</text>
                <text x="10" y="91" fill="#00bfff" font-size="11">‚Üí supplier_id</text>
                <text x="10" y="109" fill="#00bfff" font-size="11">‚Üí customer_id</text>
                <text x="10" y="127" fill="#00bfff" font-size="11">‚Üí shipping_line_id</text>
                <text x="10" y="145" fill="#fff" font-size="11">has_broker, broker_name</text>
                <text x="10" y="163" fill="#fff" font-size="11">final_beneficiary_*</text>
                <text x="110" y="195" text-anchor="middle" fill="#4ecdc4" font-size="10">17 columns</text>
            </g>
            
            <!-- ============ SHIPMENT_CARGO (TOP RIGHT) ============ -->
            <g class="table-box new-table" transform="translate(950, 80)">
                <rect width="220" height="200" rx="8" fill="#1a3d1a" stroke="#00ff88" stroke-width="2"/>
                <rect width="220" height="35" rx="8" fill="#ff6b6b"/>
                <rect y="27" width="220" height="8" fill="#ff6b6b"/>
                <text x="110" y="25" text-anchor="middle" font-weight="bold" fill="#fff" font-size="13">shipment_cargo ‚ú®</text>
                <text x="10" y="55" fill="#ffd700" font-size="11">üîë id (UUID)</text>
                <text x="10" y="73" fill="#00bfff" font-size="11">‚Üí shipment_id (FK)</text>
                <text x="10" y="91" fill="#fff" font-size="11">product_text, cargo_type</text>
                <text x="10" y="109" fill="#fff" font-size="11">container_count, weight_ton</text>
                <text x="10" y="127" fill="#fff" font-size="11">barrels, bags_count</text>
                <text x="10" y="145" fill="#fff" font-size="11">gross_weight_kg, net_weight_kg</text>
                <text x="10" y="163" fill="#fff" font-size="11">lines (JSONB), containers (JSONB)</text>
                <text x="110" y="195" text-anchor="middle" fill="#ff6b6b" font-size="10">20 columns</text>
            </g>
            
            <!-- ============ SHIPMENT_LOGISTICS (BOTTOM LEFT) ============ -->
            <g class="table-box new-table" transform="translate(50, 320)">
                <rect width="220" height="220" rx="8" fill="#1a3d1a" stroke="#00ff88" stroke-width="2"/>
                <rect width="220" height="35" rx="8" fill="#9b59b6"/>
                <rect y="27" width="220" height="8" fill="#9b59b6"/>
                <text x="110" y="25" text-anchor="middle" font-weight="bold" fill="#fff" font-size="13">shipment_logistics ‚ú®</text>
                <text x="10" y="55" fill="#ffd700" font-size="11">üîë id (UUID)</text>
                <text x="10" y="73" fill="#00bfff" font-size="11">‚Üí shipment_id (FK)</text>
                <text x="10" y="91" fill="#00bfff" font-size="11">‚Üí pol_id, ‚Üí pod_id</text>
                <text x="10" y="109" fill="#fff" font-size="11">eta, etd, bl_date</text>
                <text x="10" y="127" fill="#fff" font-size="11">booking_no, bl_no</text>
                <text x="10" y="145" fill="#fff" font-size="11">vessel_name, vessel_imo</text>
                <text x="10" y="163" fill="#fff" font-size="11">tanker_name, truck_plate</text>
                <text x="10" y="181" fill="#fff" font-size="11">customs_clearance_date</text>
                <text x="10" y="199" fill="#fff" font-size="11">final_destination (JSONB)</text>
                <text x="110" y="215" text-anchor="middle" fill="#9b59b6" font-size="10">24 columns</text>
            </g>
            
            <!-- ============ SHIPMENT_FINANCIALS (BOTTOM CENTER) ============ -->
            <g class="table-box new-table" transform="translate(330, 320)">
                <rect width="230" height="240" rx="8" fill="#1a3d1a" stroke="#00ff88" stroke-width="2"/>
                <rect width="230" height="35" rx="8" fill="#ffd93d"/>
                <rect y="27" width="230" height="8" fill="#ffd93d"/>
                <text x="115" y="25" text-anchor="middle" font-weight="bold" fill="#000" font-size="13">shipment_financials ‚ú®</text>
                <text x="10" y="55" fill="#ffd700" font-size="11">üîë id (UUID)</text>
                <text x="10" y="73" fill="#00bfff" font-size="11">‚Üí shipment_id (FK)</text>
                <text x="10" y="91" fill="#fff" font-size="11">fixed_price_usd_per_ton</text>
                <text x="10" y="109" fill="#fff" font-size="11">selling_price_usd_per_ton</text>
                <text x="10" y="127" fill="#fff" font-size="11">total_value_usd</text>
                <text x="10" y="145" fill="#fff" font-size="11">paid_value_usd</text>
                <text x="10" y="163" fill="#fff" font-size="11">balance_value_usd</text>
                <text x="10" y="181" fill="#fff" font-size="11">payment_method, lc_number</text>
                <text x="10" y="199" fill="#fff" font-size="11">beneficiary_*, swift_code</text>
                <text x="10" y="217" fill="#fff" font-size="11">payment_schedule (JSONB)</text>
                <text x="115" y="235" text-anchor="middle" fill="#ffd93d" font-size="10">27 columns</text>
            </g>
            
            <!-- ============ SHIPMENT_DOCUMENTS (BOTTOM RIGHT) ============ -->
            <g class="table-box new-table" transform="translate(620, 320)">
                <rect width="220" height="200" rx="8" fill="#1a3d1a" stroke="#00ff88" stroke-width="2"/>
                <rect width="220" height="35" rx="8" fill="#6bcb77"/>
                <rect y="27" width="220" height="8" fill="#6bcb77"/>
                <text x="110" y="25" text-anchor="middle" font-weight="bold" fill="#000" font-size="13">shipment_documents ‚ú®</text>
                <text x="10" y="55" fill="#ffd700" font-size="11">üîë id (UUID)</text>
                <text x="10" y="73" fill="#00bfff" font-size="11">‚Üí shipment_id (FK)</text>
                <text x="10" y="91" fill="#fff" font-size="11">contract_file_name</text>
                <text x="10" y="109" fill="#fff" font-size="11">documents (JSONB)</text>
                <text x="10" y="127" fill="#fff" font-size="11">docs_draft_approved</text>
                <text x="10" y="145" fill="#fff" font-size="11">original_docs_sent</text>
                <text x="10" y="163" fill="#fff" font-size="11">quality_feedback_*</text>
                <text x="110" y="195" text-anchor="middle" fill="#6bcb77" font-size="10">14 columns</text>
            </g>
            
            <!-- ============ RELATED TABLES ============ -->
            
            <!-- MILESTONES -->
            <g class="table-box" transform="translate(900, 320)">
                <rect width="180" height="100" rx="8" fill="#2d1f1f" stroke="#ff6b6b" stroke-width="2"/>
                <rect width="180" height="30" rx="8" fill="#ff6b6b"/>
                <rect y="22" width="180" height="8" fill="#ff6b6b"/>
                <text x="90" y="20" text-anchor="middle" font-weight="bold" fill="#fff" font-size="12">milestones</text>
                <text x="10" y="50" fill="#ffd700" font-size="10">üîë id</text>
                <text x="10" y="68" fill="#00bfff" font-size="10">‚Üí shipment_id</text>
                <text x="10" y="86" fill="#fff" font-size="10">code, recorded_at</text>
            </g>
            
            <!-- TRANSACTIONS -->
            <g class="table-box" transform="translate(1140, 320)">
                <rect width="180" height="120" rx="8" fill="#3d3520" stroke="#ffd93d" stroke-width="2"/>
                <rect width="180" height="30" rx="8" fill="#ffd93d"/>
                <rect y="22" width="180" height="8" fill="#ffd93d"/>
                <text x="90" y="20" text-anchor="middle" font-weight="bold" fill="#000" font-size="12">transactions</text>
                <text x="10" y="50" fill="#ffd700" font-size="10">üîë id</text>
                <text x="10" y="68" fill="#00bfff" font-size="10">‚Üí shipment_id</text>
                <text x="10" y="86" fill="#fff" font-size="10">amount_usd, direction</text>
                <text x="10" y="104" fill="#fff" font-size="10">transaction_date</text>
            </g>
            
            <!-- OUTBOUND_DELIVERIES -->
            <g class="table-box" transform="translate(1140, 480)">
                <rect width="180" height="100" rx="8" fill="#2d1f1f" stroke="#ff6b6b" stroke-width="2"/>
                <rect width="180" height="30" rx="8" fill="#ff6b6b"/>
                <rect y="22" width="180" height="8" fill="#ff6b6b"/>
                <text x="90" y="20" text-anchor="middle" font-weight="bold" fill="#fff" font-size="12">outbound_deliveries</text>
                <text x="10" y="50" fill="#ffd700" font-size="10">üîë id</text>
                <text x="10" y="68" fill="#00bfff" font-size="10">‚Üí shipment_id</text>
                <text x="10" y="86" fill="#fff" font-size="10">delivery_number, total_cost</text>
            </g>
            
            <!-- CUSTOMS_CLEARING_COSTS -->
            <g class="table-box" transform="translate(900, 460)">
                <rect width="180" height="110" rx="8" fill="#3d3520" stroke="#ffd93d" stroke-width="2"/>
                <rect width="180" height="30" rx="8" fill="#ffd93d"/>
                <rect y="22" width="180" height="8" fill="#ffd93d"/>
                <text x="90" y="20" text-anchor="middle" font-weight="bold" fill="#000" font-size="12">customs_clearing_costs</text>
                <text x="10" y="50" fill="#ffd700" font-size="10">üîë id</text>
                <text x="10" y="68" fill="#00bfff" font-size="10">‚Üí shipment_id</text>
                <text x="10" y="86" fill="#fff" font-size="10">original_clearing_amount</text>
                <text x="10" y="104" fill="#fff" font-size="10">total_clearing_cost</text>
            </g>
            
            <!-- ============ RELATIONSHIP LINES ============ -->
            
            <!-- Shipments ‚Üí Parties -->
            <path d="M 650 180 L 270 180" stroke="#4ecdc4" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
            <text x="450" y="170" fill="#4ecdc4" font-size="10">1:1</text>
            
            <!-- Shipments ‚Üí Cargo -->
            <path d="M 890 180 L 950 180" stroke="#ff6b6b" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
            <text x="910" y="170" fill="#ff6b6b" font-size="10">1:1</text>
            
            <!-- Shipments ‚Üí Logistics -->
            <path d="M 650 250 Q 400 280 270 320" stroke="#9b59b6" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
            <text x="400" y="300" fill="#9b59b6" font-size="10">1:1</text>
            
            <!-- Shipments ‚Üí Financials -->
            <path d="M 770 300 L 445 320" stroke="#ffd93d" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
            <text x="600" y="305" fill="#ffd93d" font-size="10">1:1</text>
            
            <!-- Shipments ‚Üí Documents -->
            <path d="M 770 300 L 730 320" stroke="#6bcb77" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
            <text x="750" y="305" fill="#6bcb77" font-size="10">1:1</text>
            
            <!-- Shipments ‚Üí Milestones -->
            <path d="M 890 200 Q 950 250 950 320" stroke="#ff6b6b" stroke-width="1.5" fill="none" marker-end="url(#arrow)"/>
            <text x="940" y="280" fill="#ff6b6b" font-size="9">1:N</text>
            
            <!-- Shipments ‚Üí Transactions -->
            <path d="M 890 220 Q 1100 250 1200 320" stroke="#ffd93d" stroke-width="1.5" fill="none" marker-end="url(#arrow)"/>
            <text x="1050" y="270" fill="#ffd93d" font-size="9">1:N</text>
            
            <!-- Shipments ‚Üí Deliveries -->
            <path d="M 890 240 Q 1150 350 1200 480" stroke="#ff6b6b" stroke-width="1.5" fill="none" marker-end="url(#arrow)"/>
            <text x="1100" y="400" fill="#ff6b6b" font-size="9">1:N</text>
            
            <!-- Shipments ‚Üí Customs -->
            <path d="M 890 260 Q 950 400 950 460" stroke="#ffd93d" stroke-width="1.5" fill="none" marker-end="url(#arrow)"/>
            <text x="960" y="420" fill="#ffd93d" font-size="9">1:N</text>
            
            <!-- ============ VIEWS BOX ============ -->
            <g transform="translate(1350, 80)">
                <rect width="300" height="150" rx="12" fill="rgba(0, 212, 255, 0.1)" stroke="#00d4ff" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="150" y="25" text-anchor="middle" fill="#00d4ff" font-weight="bold" font-size="14">üìã Backwards-Compatible Views</text>
                
                <text x="20" y="55" fill="#fff" font-size="12">v_shipments_unified</text>
                <text x="30" y="73" fill="#888" font-size="10">Joins all 5 tables ‚Üí 102 columns</text>
                <text x="30" y="88" fill="#888" font-size="10">Use for read operations</text>
                
                <text x="20" y="115" fill="#fff" font-size="12">v_shipments_slim</text>
                <text x="30" y="133" fill="#888" font-size="10">Essential columns only ‚Üí 25 columns</text>
                <text x="30" y="148" fill="#888" font-size="10">Use for list displays</text>
            </g>
            
            <!-- ============ LEGEND BOX ============ -->
            <g transform="translate(1350, 260)">
                <rect width="300" height="180" rx="8" fill="rgba(0,0,0,0.5)" stroke="#444"/>
                <text x="150" y="25" text-anchor="middle" fill="#00ff88" font-weight="bold" font-size="14">Legend</text>
                
                <rect x="20" y="45" width="20" height="15" fill="#00ff88" rx="3"/>
                <text x="50" y="57" fill="#fff" font-size="11">= NEW normalized table</text>
                
                <text x="20" y="85" fill="#ffd700" font-size="11">üîë = Primary Key</text>
                <text x="20" y="105" fill="#00bfff" font-size="11">‚Üí = Foreign Key</text>
                
                <text x="20" y="130" fill="#fff" font-size="11">1:1 = One-to-One (UNIQUE FK)</text>
                <text x="20" y="150" fill="#fff" font-size="11">1:N = One-to-Many</text>
                
                <line x1="20" y1="165" x2="60" y2="165" stroke="#00d4ff" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="70" y="169" fill="#888" font-size="11">= View (not a table)</text>
            </g>
            
            <!-- ============ COLUMN DISTRIBUTION ============ -->
            <g transform="translate(50, 600)">
                <rect width="1250" height="100" rx="12" fill="rgba(0, 255, 136, 0.05)" stroke="#00ff88" stroke-width="1"/>
                <text x="625" y="25" text-anchor="middle" fill="#00ff88" font-weight="bold" font-size="14">üìä Column Distribution (102 ‚Üí 5 tables + master)</text>
                
                <rect x="50" y="45" width="80" height="40" fill="#00ff88" rx="4"/>
                <text x="90" y="70" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">25</text>
                <text x="90" y="98" text-anchor="middle" fill="#00ff88" font-size="10">Master</text>
                
                <rect x="170" y="45" width="80" height="40" fill="#4ecdc4" rx="4"/>
                <text x="210" y="70" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">17</text>
                <text x="210" y="98" text-anchor="middle" fill="#4ecdc4" font-size="10">Parties</text>
                
                <rect x="290" y="45" width="80" height="40" fill="#ff6b6b" rx="4"/>
                <text x="330" y="70" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">20</text>
                <text x="330" y="98" text-anchor="middle" fill="#ff6b6b" font-size="10">Cargo</text>
                
                <rect x="410" y="45" width="80" height="40" fill="#9b59b6" rx="4"/>
                <text x="450" y="70" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">24</text>
                <text x="450" y="98" text-anchor="middle" fill="#9b59b6" font-size="10">Logistics</text>
                
                <rect x="530" y="45" width="80" height="40" fill="#ffd93d" rx="4"/>
                <text x="570" y="70" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">27</text>
                <text x="570" y="98" text-anchor="middle" fill="#ffd93d" font-size="10">Financials</text>
                
                <rect x="650" y="45" width="80" height="40" fill="#6bcb77" rx="4"/>
                <text x="690" y="70" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">14</text>
                <text x="690" y="98" text-anchor="middle" fill="#6bcb77" font-size="10">Documents</text>
                
                <text x="850" y="70" fill="#888" font-size="12">= 102 total (with overlapping audit columns)</text>
            </g>
            
            <!-- ============ SYNC STRATEGY ============ -->
            <g transform="translate(50, 720)">
                <rect width="1250" height="80" rx="12" fill="rgba(255, 217, 61, 0.05)" stroke="#ffd93d" stroke-width="1"/>
                <text x="625" y="25" text-anchor="middle" fill="#ffd93d" font-weight="bold" font-size="14">üîÑ Sync Strategy (Backwards Compatible)</text>
                
                <text x="50" y="55" fill="#fff" font-size="12">‚Ä¢ Write to shipments table ‚Üí Auto-sync to normalized tables ‚úÖ</text>
                <text x="50" y="75" fill="#888" font-size="12">‚Ä¢ Write to normalized tables ‚Üí Optional reverse sync (disabled by default)</text>
                <text x="700" y="65" fill="#00ff88" font-size="12">No code changes required for existing application!</text>
            </g>
        </svg>
    </div>
    
    <div style="text-align: center; padding: 30px; color: #666;">
        <p>Generated: December 2025 | Phase 2 Complete | Loyal Supply Chain Management System</p>
        <p style="margin-top: 10px;">Migrations: 048, 049, 050, 051</p>
    </div>
</body>
</html>

